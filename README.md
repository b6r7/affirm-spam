# Affirm SPAM (Structured Payments & Messaging)
Figma Make prototype catalog, intended to be converted into a working Figma plugin, created by Bart Andrzejewski.

This repo is a React + Vite UI prototype generated via Figma Make. It currently runs as a web app, but the UI architecture is already close to a plugin shape (canvas preview on the left, control panel on the right). The next step is to wrap the UI into Figma‚Äôs plugin runtime and connect actions (generate, export, save template, etc.) to real plugin logic.

## What this is
A prototype for an internal comms tool that:
- Lets you pick an email template and target locale
- Generates A/B/C variants across tones
- Highlights locale-specific compliance phrases and applies suggested replacements
- Supports a ‚Äúcreate new template‚Äù flow with draft preview
- Simulates exporting selected/all variants

## What this is not (yet)
- No persistence beyond Figma's clientStorage (plugin) or in-memory (web)
- ‚ÄúExport to Dyspatch‚Äù is simulated

## Tech stack
- React + TypeScript
- Vite
- Tailwind plugin present (even if minimally used)
- lucide-react icons
- Styling uses CSS variables (theme.css) for a token-like setup

## Quick start (local)
Requirements:
- Node.js 18+ recommended

Install and run:
1. `npm install`
2. `npm run dev`
3. Open the local URL shown in terminal (usually `http://localhost:5173`)

Build:
- `npm run build`
- `npm run preview`

## Figma plugin (Desktop)
The same UI runs as a Figma plugin. No paid services or network required; build is local and deterministic.

**Factory-new:** The Figma plugin ships with no seeded templates; users create or import their own. On first run you‚Äôll see an empty state with ‚ÄúAdd new‚Äù and ‚ÄúImport translations‚Äù to get started.

### Build the plugin
From the repo root:
1. `npm install`
2. `npm run build:plugin` (or `npm run plugin:build`)

**Build order:** UI is built first (`figma-plugin/ui.js`, `figma-plugin/ui.css`), then the main thread build inlines that UI into `code.js` as `__html__`, so Figma‚Äôs `showUI(__html__)` has no relative URLs.

**Plugin directory:** Figma loads the plugin from the folder that contains `manifest.json`. Use the **`figma-plugin/`** folder: that‚Äôs where `manifest.json`, `code.js`, `ui.html`, `ui.js`, and `ui.css` live after a build.

Optional: run `npm run plugin:watch` to rebuild `code.js` on change (run `npm run build:plugin` when you change the UI).

### Run the plugin in Figma Desktop
1. Open **Figma Desktop** (desktop app, not browser).
2. **Plugins** ‚Üí **Development** ‚Üí **Import plugin from manifest‚Ä¶**
3. Select the file **`figma-plugin/manifest.json`** (in this repo).
4. The plugin appears under **Plugins** ‚Üí **Development** ‚Üí **Affirm SPAM**. Run it to open the sidebar.

If Figma reports a missing file (e.g. `code.js`), run `npm run plugin:build` again and re-import the manifest.

### If UI is blank in Figma
The UI is inlined into `code.js` as `__html__` (HTML + JS + CSS), so the plugin has no relative resource URLs. If the sidebar is blank:

1. **Rebuild and verify inlined HTML**
   - From repo root: `npm run build:plugin`
   - Open `figma-plugin/code.js`: the first line should be `var __html__ = "<!DOCTYPE html>...` and the string should contain `UI BOOT MARKER` (visible in the UI when the correct HTML is used).
2. **Re-import in Figma**
   - **Plugins** ‚Üí **Development** ‚Üí **Import plugin from manifest‚Ä¶** and select **`figma-plugin/manifest.json`** (the plugin directory is **figma-plugin/**).
3. **Check what‚Äôs running**
   - You should see ‚ÄúUI BOOT MARKER‚Äù in the plugin window and, in the plugin console, ‚ÄúUI LOADED‚Äù and ‚ÄúPlugin UI mounted‚Äù. The `<pre id="bootlog">` in the inlined HTML surfaces `window.onerror` and `unhandledrejection` if something fails.

## Project structure (high level)
- `src/App.tsx`
  - Main layout, core state, and top-level interactions
  - Renders the canvas (variants / draft preview / compliance)
  - Renders the right panel (`CommsForgePanel`)
- `src/components/`
  - UI building blocks for the right panel and canvas
- `src/data/`
  - `contentData.ts` contains the locale/tone/variant copy and compliance rules
  - `templateData.ts` contains template metadata used by TemplateSelector
- `src/styles/`
  - `theme.css` defines CSS variables (tokens)
  - `index.css`, `tailwind.css`, `fonts.css` as generated by Make
- `imports/`
  - Generated SVG/icon imports (example: `üß¨AffirmLogoMobile.tsx`)

Reference:
- `ATTRIBUTIONS.md` documents generated assets and attributions.

## Core files you‚Äôll touch most
- `src/App.tsx`
  - Owns state: locale, tone, selected variants, template selection, draft mode, export state
  - Compliance replacement logic: `applyComplianceReplacements(...)`
  - Canvas rendering: `EmailVariant`, `DraftEmailCard`, `CompliancePanel`
- `src/components/CommsForgePanel.tsx`
  - Right rail: template selector, locale select, tone controls, variants selection, export buttons
  - Enters ‚Äúcreate new template‚Äù mode via `TemplateCreationPanel`
- `src/components/TemplateCreationPanel.tsx`
  - Draft creation UI (load vs override)
  - Draft preview is currently simulated
- `src/components/TemplateSelector.tsx`
  - Dropdown for selecting templates
- `src/components/EmailVariant.tsx`
  - Variant card rendering + compliance highlight overlay

## How the prototype flows work today
### Normal mode
- Left: shows A/B/C variant cards (based on locale + tone)
- Right: controls for template, locale, tone, selecting variants to export, export buttons
- Compliance warnings shown on canvas if locale rules exist

### Draft creation mode
- Right: shows TemplateCreationPanel
- Left: shows DraftEmailCard (preview)
- Save currently simulates a new template (the expected final behavior is: create a new template entry and persist it)

## Converting this into a real Figma plugin (Cursor handoff notes)
This repo is currently a web app. A Figma plugin is two parts:
1. Plugin ‚Äúmain‚Äù (runs in Figma, has access to Figma API)
2. Plugin ‚ÄúUI‚Äù (an iframe running HTML/JS, no direct Figma API access)

### Recommended conversion approach
Keep your current React UI as the plugin UI, and create a small ‚Äúmain‚Äù controller that:
- Receives messages from UI (generate/export/save template)
- Calls Figma API as needed
- Responds back with results (created nodes, stored data, export payloads, etc.)

### Plugin file set (already in repo)
- `figma-plugin/manifest.json` ‚Äî Figma plugin manifest; `main` points to `code.js`, `ui` to `ui.html`.
- `src/plugin/code.ts` ‚Äî Main thread entry; built with esbuild to `figma-plugin/code.js`.
- `src/plugin/ui.tsx` ‚Äî React UI entry (reuses `AppView`); built with Vite to `figma-plugin/ui.js` + `ui.css`.
- `figma-plugin/ui.html` ‚Äî Loads `ui.css` and `ui.js`. Shared types/storage/translations live in `figma-plugin/`.

### UI <-> main message contract (suggested)
Define a small typed protocol:
- `INSERT_TO_CANVAS` (no payload; uses current template/locale/tone/variants to insert frame on canvas)
- `APPLY_COMPLIANCE_FIX` { locale, issueIndex } (or pass phrase)
- `SAVE_TEMPLATE` { name, locale, body }
- `EXPORT_SELECTED` { templateId, locale, tone, variants: ['A','B'] }
- `EXPORT_ALL` { templateId, locale, tone }

Responses:
- `VARIANTS_GENERATED` { variantsPayload }
- `TEMPLATE_SAVED` { templateId, templateMeta }
- `EXPORT_DONE` { status, count, destination }

### Persistence strategy (plugin)
For templates, you‚Äôll likely want:
- `figma.clientStorage` for per-user storage, simple and fast
- Or `figma.root.setPluginData` for document-scoped storage if templates should travel with the file

Draft recommendation:
- Use `clientStorage` for saved templates + history
- Use `pluginData` only if the template catalog must be embedded in a file

### Fonts and styling in Figma UI
Your UI is rendered in an iframe, so fonts must be available to the UI bundle:
- If you rely on custom fonts (Axiforma/Calibre), the UI might fall back unless bundled/hosted.
- For a plugin-ready build, prefer:
  - System fonts, or
  - Bundle webfont files in `assets/` and reference them in `fonts.css`, or
  - Use Figma‚Äôs default UI font stack for the plugin UI.

### Assets
- Keep SVGs local. The `imports/` folder already fits this.
- Avoid remote asset URLs inside the plugin UI unless you control hosting.

## Known prototype constraints
- Compliance highlighting is currently a simple `indexOf` search per issue (first occurrence). If you need multiple occurrences and multiple phrases, update `highlightText(...)` to scan globally.
- Template creation is mostly ‚Äúdemo mode‚Äù today. Real version should:
  - Persist template metadata and body per locale
  - Show the new template in selector immediately
  - Maintain a template history trail (versions) if needed

## Development workflow tips for Cursor
- Prefer full-file replacements for component edits (keeps diffs clear)
- When moving to plugin mode:
  - Split concerns cleanly: UI state stays in React; Figma actions live in `code.ts`
  - Add a typed bridge layer early so you don‚Äôt end up with stringly-typed message chaos
  - Keep UI logic deterministic (no random IDs without a wrapper function) so it‚Äôs testable

## Attribution
See `ATTRIBUTIONS.md` for generated assets, icons, and tool attribution details.

## License
Internal prototype. No external distribution intended unless explicitly re-licensed.
